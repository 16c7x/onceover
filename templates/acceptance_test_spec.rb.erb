require 'spec_helper_acceptance'

describe "Acceptance Testing" do
  before :each do |test|
    #try to find the indentation level and mirror it in beaker logger
    padding = ""
    # Get the depth and add that as padding
    (test.metadata[:scoped_id].split(':').count - 1).times do
      padding << "  "
    end
    logger.line_prefix = padding
  end
<% tests.each do |test| -%>
<% test.nodes.each do |node| -%>
<% test.classes.each do |cls| -%>
  describe "<%= cls.name %> on <%= node.name %>" do
    after :all do
      logger.line_prefix = "    "
      $nwm.cleanup
    end

    describe "provisioning <%= node.name %>" do
      #after :all do
      #  # Reset the HOSTS hash to its original value
      #  options[:HOSTS] = $original_hosts
      #end

      it "should be able to set up a Beaker Network Manger object to handle the hypervisors" do
        current_opts = {}
        OPTIONS.each do |opt,val|
          if opt == :HOSTS
            val.each do |k,v|
              if k == :<%= node.name %>
                current_opts[:HOSTS] = {k => v}
              end
            end
          else
            current_opts[opt] = val
          end
        end

        # I copied this code off the internet, basically it allows us
        # to refer to each key as either a string or an object
        current_opts.default_proc = proc do |h, k|
          case k
            when String then sym = k.to_sym; h[sym] if h.key?(sym)
            when Symbol then str = k.to_s; h[str] if h.key?(str)
          end
        end

        expect {
          $nwm = Beaker::NetworkManager.new(current_opts,logger)
        }.to_not raise_exception
      end

      it "should be able to provision using Beaker" do
        expect {
          $nwm.provision
          $nwm.proxy_package_manager
          $nwm.validate
          $nwm.configure
          $hosts = $nwm.instance_variable_get(:@hosts)
        }.not_to raise_exception
      end
    end

    describe "copying code to <%= node.name %>" do
      it "should copy the code successfully" do
        expect {
          scp_to $hosts, 'etc', '/'
        }.not_to raise_exception
      end
    end

    describe "running puppet" do
      it "should run with no errors" do
        expect {
          manifest = <<CODE
$controlrepo_accpetance = true

<%= pre_condition %>

include <%= cls.name %>
CODE
          apply_manifest_on($hosts,manifest,{:catch_failures => true})
        }.not_to raise_exception
      end
    end

    describe "checking for idempotency" do
      it "should run with no changes" do
        expect {
          manifest = <<CODE
$controlrepo_accpetance = true

<%= pre_condition %>

include <%= cls.name %>
CODE
          apply_manifest_on($hosts,manifest,{:catch_changes => true})
        }.not_to raise_exception
      end
    end
  end
<% end -%>
<% end -%>
<% end -%>
end

